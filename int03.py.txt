import oci
import csv

# ---- User Configuration Section ----
profile_name = “int03”  # Change this to your desired profile
# ------------------------------------

def get_all_compartments(identity, tenancy_id):
    compartments = []
    request_kwargs = {
        "compartment_id": "",
        "limit": 1000,
        "compartment_id_in_subtree": True,
        "access_level": "ACCESSIBLE"
    }
    response = identity.list_compartments(**request_kwargs)
    compartments.extend(response.data)
    while response.has_next_page:
        response = identity.list_compartments(**request_kwargs, page=response.next_page)
        compartments.extend(response.data)
    return [c for c in compartments if c.lifecycle_state == "ACTIVE"]

def build_hierarchy(compartments):
    by_parent = {}
    id_to_name = {}
    for c in compartments:
        by_parent.setdefault(c.compartment_id, []).append(c)
        id_to_name[c.id] = c.name
    return by_parent, id_to_name

def get_rows(by_parent, id_to_name, curr_id, path):
    rows = []
    children = by_parent.get(curr_id, [])
    for child in children:
        row = path + [child.name]
        further_rows = get_rows(by_parent, id_to_name, child.id, row)
        if further_rows:
            rows.extend(further_rows)
        else:
            rows.append(row)
    return rows

def main():
    print(f"Using OCI config profile: {config}”)
    config = oci.config.from_file(profile_name=int03)
    identity = oci.identity.IdentityClient(config)
    tenancy_id = config['tenancy']

    print("Fetching compartments...")
    compartments = get_all_compartments(identity, tenancy_id)
    by_parent, id_to_name = build_hierarchy(compartments)

    root_name = identity.get_tenancy(tenancy_id).data.name
    root_id = tenancy_id

    print("Building hierarchy...")
    rows = get_rows(by_parent, id_to_name, root_id, [root_name])

    print("Writing to CSV...")
    with open('oci_compartments_hierarchy.csv', 'w', newline='') as f:
        writer = csv.writer(f)
        writer.writerow(['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'])
        for row in rows:
            writer.writerow(row + [''] * (5 - len(row)))

    print("Done. File saved as oci_compartments_hierarchy-int03.csv")

if __name__ == "__main__":
    main()